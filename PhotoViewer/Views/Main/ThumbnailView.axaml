<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:PhotoViewer.Views"
             xmlns:vm="clr-namespace:PhotoViewer.ViewModels"
             xmlns:i="clr-namespace:Avalonia.Xaml.Interactivity;assembly=Avalonia.Xaml.Interactivity"
             xmlns:behaviors="clr-namespace:PhotoViewer.Behaviors"
             xmlns:converters="clr-namespace:PhotoViewer.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="120"
             x:Class="PhotoViewer.Views.ThumbnailView"
             x:DataType="vm:FolderViewModel">

    <UserControl.Resources>
        <!-- 布尔到边框颜色转换器 -->
        <local:BoolToCurrentBorderConverter x:Key="BoolToBorderConverter" />

        <!-- 文件大小转换器 -->
        <local:FileSizeConverter x:Key="FileSizeConverter" />

        <!-- 拍摄日期格式转换器 -->
        <local:PhotoDateConverter x:Key="PhotoDateConverter" />

        <!-- 缓存状态到边框颜色转换器 -->
        <local:BoolToCachedBorderConverter x:Key="CachedBorderConverter" />

        <!-- 旋转角度到变换转换器 -->
        <local:RotationTransformConverter x:Key="RotationTransformConverter" />

        <!-- 水平翻转到变换转换器 -->
        <local:FlipTransformConverter x:Key="FlipTransformConverter" />
    </UserControl.Resources>
    
    <UserControl.Styles>
        <!-- 下拉样式 -->
        <Style Selector="ComboBox">
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="BorderBrush" Value="#444" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>
    </UserControl.Styles>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- 排序工具栏 -->
        <StackPanel Grid.Row="0"
                    Spacing="5"
                    Margin="10"
                    HorizontalAlignment="Center"
                    Orientation="{Binding IsVerticalLayout, Converter={x:Static converters:LayoutOrientationConverter.Instance}}">
            <ComboBox Name="SortByComboBox"
                      ItemsSource="{Binding SortModes}"
                      SelectedValue="{Binding SortMode}"
                      SelectedValueBinding="{Binding Value}"
                      HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
            <ComboBox Name="OrderComboBox"
                      ItemsSource="{Binding SortOrders}"
                      SelectedValue="{Binding SortOrder}"
                      SelectedValueBinding="{Binding Value}"
                      HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
        </StackPanel>

        <!-- 缩略图列表 -->
        <ScrollViewer Grid.Row="1"
                      Name="ThumbnailScrollViewer"
                      Padding="10,0,10,0"
                      HorizontalScrollBarVisibility="{Binding IsVerticalLayout, Converter={x:Static converters:ScrollBarVisibilityConverter.Instance}}"
                      VerticalScrollBarVisibility="{Binding IsVerticalLayout, Converter={x:Static converters:ScrollBarVisibilityConverter.Instance}, ConverterParameter=Reverse}">
            <i:Interaction.Behaviors>
                <behaviors:HorizontalScrollWheelBehavior IsEnabled="{Binding !IsVerticalLayout}" />
            </i:Interaction.Behaviors>

            <ItemsControl Name="ThumbnailItemsControl"
                          ItemsSource="{Binding Main.FolderVM.FilteredFiles}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="6"
                                    HorizontalAlignment="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, Converter={x:Static converters:VerticalLayoutAlignmentConverter.Instance}}"
                                    Orientation="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, Converter={x:Static converters:LayoutOrientationConverter.Instance}}" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button
                            Command="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).SelectImageCommand}"
                            CommandParameter="{Binding}"
                            Background="Transparent"
                            BorderThickness="0"
                            Margin="0"
                            Padding="0"
                            CornerRadius="8"
                            HorizontalAlignment="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, Converter={x:Static converters:VerticalLayoutAlignmentConverter.Instance}}">

                            <!-- 主要边框（选中状态） -->
                            <Border BorderThickness="2"
                                    BorderBrush="{Binding IsCurrent, Converter={StaticResource BoolToBorderConverter}}"
                                    CornerRadius="7"
                                    Margin="0"
                                    Padding="0"
                                    Width="90"
                                    Height="120"
                                    Background="#222">
                                
                                <StackPanel Orientation="Vertical" 
                                            HorizontalAlignment="Center"
                                            Margin="0,3,0,0" 
                                            Spacing="4">
                                    <!-- 缩略图容器 -->
                                    <Border Width="80"
                                            Height="80"
                                            Background="#333"
                                            CornerRadius="4"
                                            BorderThickness="1"
                                            BorderBrush="{Binding IsInCache, Converter={StaticResource CachedBorderConverter}}">
                                        <Grid>
                                            <!-- 缩略图 -->
                                            <Image Source="{Binding Thumbnail}"
                                                   Stretch="Uniform"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   IsVisible="{Binding Thumbnail, Converter={x:Static ObjectConverters.IsNotNull}}">
                                                <Image.RenderTransform>
                                                    <TransformGroup>
                                                        <!-- 旋转变换 -->
                                                        <RotateTransform Angle="{Binding RotationAngle}" />
                                                        <!-- 水平翻转变换 -->
                                                        <ScaleTransform ScaleX="{Binding NeedsHorizontalFlip, Converter={StaticResource FlipTransformConverter}}" ScaleY="1" />
                                                    </TransformGroup>
                                                </Image.RenderTransform>
                                            </Image>

                                            <!-- 加载指示器 -->
                                            <ProgressBar IsVisible="{Binding IsThumbnailLoading}"
                                                         IsIndeterminate="True"
                                                         Width="60"
                                                         Height="4"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center" />

                                            <!-- 无缩略图占位符 -->
                                            <TextBlock Text="📷"
                                                       FontSize="24"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       Foreground="#666666">
                                                <TextBlock.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                        <Binding Path="!IsThumbnailLoading" />
                                                        <Binding Path="Thumbnail"
                                                                 Converter="{x:Static ObjectConverters.IsNull}" />
                                                    </MultiBinding>
                                                </TextBlock.IsVisible>
                                            </TextBlock>
                                        </Grid>
                                    </Border>

                                    <!-- 文件信息 -->
                                    <StackPanel Orientation="Vertical" Spacing="2">
                                        <TextBlock Text="{Binding Name}"
                                                   TextWrapping="NoWrap"
                                                   TextTrimming="CharacterEllipsis"
                                                   Foreground="#EEEEEE"
                                                   FontSize="10"
                                                   FontWeight="SemiBold"
                                                   HorizontalAlignment="Center"
                                                   MaxWidth="90" />
                                        
                                        <!-- <TextBlock -->
                                        <!--     Text="{Binding FileSize, Converter={StaticResource FileSizeConverter}}" -->
                                        <!--     FontSize="9" -->
                                        <!--     Foreground="#AAAAAA" -->
                                        <!--     HorizontalAlignment="Center" /> -->

                                        <TextBlock
                                            Text="{Binding PhotoDate, Converter={StaticResource PhotoDateConverter}}"
                                            FontSize="9"
                                            Foreground="#AAAAAA"
                                            HorizontalAlignment="Center"
                                            ToolTip.Tip="{Binding PhotoDate}" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>