<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:PhotoViewer.Views"
             xmlns:vm="clr-namespace:PhotoViewer.ViewModels"
             xmlns:i="clr-namespace:Avalonia.Xaml.Interactivity;assembly=Avalonia.Xaml.Interactivity"
             xmlns:behaviors="clr-namespace:PhotoViewer.Behaviors"
             xmlns:converters="clr-namespace:PhotoViewer.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="120"
             x:Class="PhotoViewer.Views.ThumbnailView"
             x:DataType="vm:FolderViewModel">

    <UserControl.Resources>
        <!-- 布尔到边框颜色转换器 -->
        <local:BoolToCurrentBorderConverter x:Key="BoolToBorderConverter" />

        <!-- 文件大小转换器 -->
        <local:FileSizeConverter x:Key="FileSizeConverter" />

        <!-- 拍摄日期格式转换器 -->
        <local:PhotoDateConverter x:Key="PhotoDateConverter" />

        <!-- 缓存状态到边框颜色转换器 -->
        <local:BoolToCachedBorderConverter x:Key="CachedBorderConverter" />

        <!-- 旋转角度到变换转换器 -->
        <local:RotationTransformConverter x:Key="RotationTransformConverter" />

        <!-- 水平翻转到变换转换器 -->
        <local:FlipTransformConverter x:Key="FlipTransformConverter" />

        <!-- 星级颜色转换器 -->
        <local:StarColorConverter x:Key="StarColorConverter" />
        
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- 下拉样式 -->
        <Style Selector="ComboBox">
            <Setter Property="Width" Value="90" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="BorderBrush" Value="#444" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>
        
        <!-- 星级按钮样式 -->
        <Style Selector="Button.ThumbStarButton">
            <Setter Property="Width" Value="14" />
            <Setter Property="Height" Value="14" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style Selector="Button.ThumbStarButton:pointerover">
            <Setter Property="Background" Value="#333" />
        </Style>

        <!-- 禁用状态的星级按钮样式 -->
        <Style Selector="Button.ThumbStarButton:disabled">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <Style Selector="Button.ThumbStarButton:disabled:pointerover">
            <Setter Property="Background" Value="Transparent" />
        </Style>

        <Style Selector="TextBlock.ThumbStarButtonSymbol">
            <Setter Property="FontSize" Value="10" />
            <Setter Property="FontFamily" Value="{StaticResource UiconsFontSolidStraight}" />
        </Style>
    </UserControl.Styles>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 排序工具栏 -->
        <StackPanel x:Name="FilterBarPanel"
                    Grid.Row="0"
                    Spacing="5"
                    Margin="10"
                    HorizontalAlignment="Center"
                    Orientation="{Binding IsVerticalLayout, Converter={x:Static converters:LayoutOrientationConverter.Instance}}">

            <!-- 文件夹名 -->
            <!-- <TextBlock Text="{Binding FolderName}" -->
            <!--            HorizontalAlignment="Center" -->
            <!--            VerticalAlignment="Center" -->
            <!--            Foreground="#DDD" -->
            <!--            FontSize="12" -->
            <!--            MaxWidth="90"  -->
            <!--            TextWrapping="Wrap" /> -->
            
            <!-- 排序方式下拉框 -->
            <ComboBox Name="SortByComboBox"
                      ItemsSource="{Binding SortModes}"
                      SelectedValue="{Binding SortMode}"
                      SelectedValueBinding="{Binding Value}"
                      HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>

            <!-- 排序顺序下拉框 -->
            <ComboBox Name="OrderComboBox"
                      ItemsSource="{Binding SortOrders}"
                      SelectedValue="{Binding SortOrder}"
                      SelectedValueBinding="{Binding Value}"
                      HorizontalAlignment="Stretch">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>

            <!-- 星级筛选 -->
            <ComboBox ItemsSource="{Binding RatingFilters}"
                      SelectedValue="{Binding SelectedRatingFilter}"
                      SelectedValueBinding="{Binding Key}">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding DisplayName}" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>

            <!-- 筛选后计数 -->
            <TextBlock Text="{Binding FilteredCount, StringFormat='共 {0} 张'}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="#DDD"
                       FontSize="12"/>
        </StackPanel>

        <!-- 缩略图列表 -->
        <ScrollViewer Grid.Row="1"
                      Name="ThumbnailScrollViewer"
                      HorizontalScrollBarVisibility="{Binding IsVerticalLayout, 
                            Converter={x:Static converters:ScrollBarVisibilityConverter.Instance}}"
                      VerticalScrollBarVisibility="{Binding IsVerticalLayout, 
                            Converter={x:Static converters:ScrollBarVisibilityConverter.Instance}, 
                            ConverterParameter=Reverse}">
            <i:Interaction.Behaviors>
                <behaviors:HorizontalScrollWheelBehavior IsEnabled="{Binding !IsVerticalLayout}" />
            </i:Interaction.Behaviors>

            <ItemsControl Name="ThumbnailItemsControl"
                          ItemsSource="{Binding Main.FolderVM.FilteredFiles}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel HorizontalAlignment="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, 
                                        Converter={x:Static converters:VerticalLayoutAlignmentConverter.Instance}}"
                                    Orientation="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, 
                                        Converter={x:Static converters:LayoutOrientationConverter.Instance}}" 
                                    Margin="10,0,10,10"
                                    Spacing="6" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button
                            Command="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).SelectImageCommand}"
                            CommandParameter="{Binding}"
                            Background="Transparent"
                            BorderThickness="0"
                            Margin="0"
                            Padding="0"
                            CornerRadius="8"
                            HorizontalAlignment="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).IsVerticalLayout, 
                                Converter={x:Static converters:VerticalLayoutAlignmentConverter.Instance}}">

                            <!-- 主要边框（选中状态） -->
                            <Border BorderThickness="2"
                                    BorderBrush="{Binding IsCurrent, Converter={StaticResource BoolToBorderConverter}}"
                                    CornerRadius="7"
                                    Margin="0"
                                    Padding="0"
                                    Width="90"
                                    Height="138"
                                    Background="#222">

                                <StackPanel Orientation="Vertical"
                                            HorizontalAlignment="Center"
                                            Margin="0,3,0,0"
                                            Spacing="4">
                                    <!-- 缩略图容器 -->
                                    <Border Width="80"
                                            Height="80"
                                            Background="#333"
                                            CornerRadius="4"
                                            BorderThickness="1"
                                            BorderBrush="{Binding IsInCache, 
                                                Converter={StaticResource CachedBorderConverter}}">
                                        <Grid>
                                            <!-- 缩略图 -->
                                            <Image Source="{Binding Thumbnail}"
                                                   Stretch="Uniform"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   IsVisible="{Binding Thumbnail, 
                                                        Converter={x:Static ObjectConverters.IsNotNull}}">
                                                <Image.RenderTransform>
                                                    <TransformGroup>
                                                        <!-- 旋转变换 -->
                                                        <RotateTransform Angle="{Binding RotationAngle}" />
                                                        <!-- 水平翻转变换 -->
                                                        <ScaleTransform
                                                            ScaleX="{Binding NeedsHorizontalFlip, 
                                                            Converter={StaticResource FlipTransformConverter}}"
                                                            ScaleY="1" />
                                                    </TransformGroup>
                                                </Image.RenderTransform>
                                            </Image>

                                            <!-- 加载指示器 -->
                                            <ProgressBar IsVisible="{Binding IsThumbnailLoading}"
                                                         IsIndeterminate="True"
                                                         Width="60"
                                                         Height="4"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center" />

                                            <!-- 无缩略图占位符 -->
                                            <TextBlock Text="📷"
                                                       FontSize="24"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       Foreground="#666666">
                                                <TextBlock.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                        <Binding Path="!IsThumbnailLoading" />
                                                        <Binding Path="Thumbnail"
                                                                 Converter="{x:Static ObjectConverters.IsNull}" />
                                                    </MultiBinding>
                                                </TextBlock.IsVisible>
                                            </TextBlock>
                                        </Grid>
                                    </Border>

                                    <!-- 文件信息 -->
                                    <StackPanel Orientation="Vertical" Spacing="2">
                                        <TextBlock Text="{Binding DisplayName}"
                                                   FontSize="10"
                                                   Foreground="#EEEEEE"
                                                   FontWeight="SemiBold"
                                                   HorizontalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxWidth="90" />
                                        <TextBlock Text="{Binding PhotoDate, Converter={StaticResource PhotoDateConverter}}"
                                                   FontSize="9"
                                                   Foreground="#AAAAAA"
                                                   HorizontalAlignment="Center"
                                                   ToolTip.Tip="{Binding PhotoDate}" />

                                        <!-- 星级行（缩略图内） -->
                                        <StackPanel Orientation="Horizontal"
                                                    HorizontalAlignment="Center"
                                                    IsVisible="{Binding $parent[UserControl].((vm:FolderViewModel)DataContext).Main.Settings.ShowRating}">
                                            <!-- 0星 -->
                                            <Button Classes="ThumbStarButton" Tag="0" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xf4f8;"
                                                           FontSize="8"
                                                           Foreground="#666"/>
                                            </Button>
                                            <!-- 1~5星 -->
                                            <Button Classes="ThumbStarButton" Tag="1" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xfcd7;"
                                                           Foreground="{Binding Rating, Converter={StaticResource StarColorConverter}, ConverterParameter=1}"/>
                                            </Button>
                                            <Button Classes="ThumbStarButton" Tag="2" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xfcd7;"
                                                           Foreground="{Binding Rating, Converter={StaticResource StarColorConverter}, ConverterParameter=2}"/>
                                            </Button>
                                            <Button Classes="ThumbStarButton" Tag="3" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xfcd7;"
                                                           Foreground="{Binding Rating, Converter={StaticResource StarColorConverter}, ConverterParameter=3}"/>
                                            </Button>
                                            <Button Classes="ThumbStarButton" Tag="4" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xfcd7;"
                                                           Foreground="{Binding Rating, Converter={StaticResource StarColorConverter}, ConverterParameter=4}"/>
                                            </Button>
                                            <Button Classes="ThumbStarButton" Tag="5" Click="OnThumbStarClick">
                                                <TextBlock Classes="ThumbStarButtonSymbol" Text="&#xfcd7;"
                                                           Foreground="{Binding Rating, Converter={StaticResource StarColorConverter}, ConverterParameter=5}"/>
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
    </Grid>
</UserControl>